extend layout

block scenarios

  //- Left join each scenario with its sessions. Select only launchable scenarios (with documents)
  //- and joinable sessions (with instances).

  -
    var scenario_sessions = scenarios.filter( function( scenario ) {
      return scenario.document;
    } ).reduce( function( scenario_sessions, scenario ) {
      var sessions = ( scenario.sessions || [] ).filter( function( session ) {
        return session.instance;
      } );
      return scenario_sessions.concat( sessions.map( function( session ) {
        return { scenario: scenario, session: session };
      } ) ).concat( { scenario: scenario, session: undefined } );
    }, [] );

  table.table#scenarios
    thead
      tr
        th.col-sm-5 Scenario
        th.col-sm-1 Company
        th.col-sm-1 Platoon
        th.col-sm-1 Unit
        th.col-sm-3 &nbsp;
        th.col-sm-1 &nbsp;
    tbody
      each scenario_session in scenario_sessions
        -
          var scenario = scenario_session.scenario,
            session = scenario_session.session;
        if session
          tr.session
            td= scenario.state.title
              br
              span.small instructor, n students
            td= session.state.classroom.company
            td= session.state.classroom.platoon
            td= session.state.classroom.unit
            td &nbsp;
            td: a.btn.join(href=session.instance) Join
        else if user.instructor
          tr.scenario
            td= scenario.state.title
            td.company: input.form-control.input-sm
            td.platoon: input.form-control.input-sm
            td.unit: input.form-control.input-sm
            td &nbsp;
            td
              a.btn.edit(href=scenario.document.uri) Edit
              a.btn.launch.hidden(href=scenario.document.uri) Launch
      if user.instructor
        tr.application
          td.title(colspan=4): input(placeholder="Title").form-control.input-sm
          td &nbsp;
          td: a.btn.create.disabled(href=scenarios.application) Create
    script.
      document.addEventListener( "DOMContentLoaded", function() {
        $( "table#scenarios" ).on( "input", "tr.scenario", function() {
          var this$ = $( this ), filled = this$.find( ".company input" ).val() &&
            this$.find( ".platoon input" ).val() &&
            this$.find( ".unit input" ).val();
          if ( filled ) {
            this$.find( "a.edit" ).addClass( "hidden" );
            this$.find( "a.launch" ).removeClass( "hidden" );
          } else {
            this$.find( "a.edit" ).removeClass( "hidden" );
            this$.find( "a.launch" ).addClass( "hidden" );
          }
        } );
        $( "table#scenarios" ).on( "input", "tr.application", function() {
          var this$ = $( this ),
            filled = this$.find( ".title input" ).val();
          if ( filled ) {
            this$.find( "a.create" ).removeClass( "disabled" );
          } else {
            this$.find( "a.create" ).addClass( "disabled" );
          }
        } );
      } );

block sessions

  //- Join each scenario with its sessions. Select only completed sessions (with documents).

  -
    var scenario_sessions = scenarios.reduce( function( scenario_sessions, scenario ) {
      var sessions = ( scenario.sessions || [] ).filter( function( session ) {
        return session.document;
      } );
      return scenario_sessions.concat( sessions.map( function( session ) {
        return { scenario: scenario, session: session };
      } ) );
    }, [] ).sort( function( a, b ) {
      return b.session.document.timestamp - a.session.document.timestamp;
    } );

  table.table#sessions
    thead
      tr
        th.col-sm-5 Scenario
        th.col-sm-1 Company
        th.col-sm-1 Platoon
        th.col-sm-1 Unit
        th.col-sm-3 Date
        th.col-sm-1 &nbsp;
    tbody: each scenario_session in scenario_sessions
      -
        var scenario = scenario_session.scenario,
          session = scenario_session.session;
      tr
        td= session.state.title
        td= session.state.classroom.company
        td= session.state.classroom.platoon
        td= session.state.classroom.unit
        td= ( new Date( session.document.timestamp ) ).toISOString()
        td: a.btn.review(href=session.document.uri) Review
